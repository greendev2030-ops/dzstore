// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id            String    @id @default(uuid())
  username      String    @unique
  password_hash String
  role          String    @default("admin")
  created_at    DateTime  @default(now())
}

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  password_hash String?
  phone       String?
  full_name   String?
  address     String?
  wilaya      String?
  created_at  DateTime  @default(now())
  orders      Order[]
  support_tickets SupportTicket[]
  returns     Return[]
}

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  created_at  DateTime  @default(now())
  products    Product[]
}

model Product {
  id             String      @id @default(uuid())
  category_id    String
  category       Category    @relation(fields: [category_id], references: [id])
  name           String
  slug           String      @unique
  description    String
  price          Decimal
  cost_price     Decimal     @default(0) // Purchase price for profit calculation
  discount_price Decimal?    // New field for sale price
  delivery_fee   Decimal     @default(0) // Delivery fee for this product (0 = free)
  stock_quantity Int
  image_url      String
  specs          String      // JSON string
  is_active      Boolean     @default(true)
  is_featured    Boolean     @default(false) // New field for manual highlighting
  created_at     DateTime    @default(now())
  order_items    OrderItem[]
  reviews        Review[]
}

model Order {
  id            String      @id @default(uuid())
  user_id       String?
  user          User?       @relation(fields: [user_id], references: [id])
  guest_name    String?
  guest_email   String?
  guest_phone   String?
  guest_address String?
  guest_wilaya  String?
  guest_commune String?
  total_amount  Decimal
  status        String      @default("PENDING") // PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED
  created_at    DateTime    @default(now())
  updated_at    DateTime    @updatedAt
  items         OrderItem[]
}

model OrderItem {
  id         String  @id @default(uuid())
  order_id   String
  product_id String
  quantity   Int
  price      Decimal
  order      Order   @relation(fields: [order_id], references: [id])
  product    Product @relation(fields: [product_id], references: [id])
}

model Review {
  id         String   @id @default(uuid())
  product_id String
  user_name  String
  rating     Int
  comment    String
  created_at DateTime @default(now())
  product    Product  @relation(fields: [product_id], references: [id])
}

model Return {
  id              String   @id @default(uuid())
  user_id         String?  // Link to User if logged in
  user            User?    @relation(fields: [user_id], references: [id])
  order_id        String
  product_id      String
  customer_phone  String
  customer_name   String?
  reason          String   // DAMAGED, WRONG_ITEM, NOT_WORKING, WRONG_SIZE, POOR_QUALITY, LATE_DELIVERY, WRONG_ORDER, OTHER
  detailed_reason String?  @db.Text
  images          String?  @db.Text // JSON array of image URLs
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  admin_notes     String?  @db.Text
  refund_amount   Decimal?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  @@index([user_id])
  @@index([customer_phone])
}

model CustomerScore {
  id                String   @id @default(uuid())
  phone             String   @unique
  name              String?
  trust_score       Int      @default(100)
  total_orders      Int      @default(0)
  total_returns     Int      @default(0)
  successful_orders Int      @default(0)
  status            String   @default("GOOD") // GOOD, WARNING, WATCH, BLACKLISTED
  blacklist_reason  String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
}

model ScoreHistory {
  id             String   @id @default(uuid())
  customer_phone String
  action         String
  points_change  Int      // Positive or negative
  previous_score Int
  new_score      Int
  notes          String?
  created_at     DateTime @default(now())
}

model SupportTicket {
  id            String   @id @default(uuid())
  user_id       String
  user          User     @relation(fields: [user_id], references: [id])
  
  subject       String
  type          String   // PHONE_CHANGE, BLACKLIST_INQUIRY, ORDER_ISSUE, GENERAL
  priority      String   @default("NORMAL") // HIGH, NORMAL, LOW
  status        String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  
  description   String   @db.Text
  attachment_url String?
  
  admin_notes   String?  @db.Text
  resolved_by   String?
  resolved_at   DateTime?
  
  messages      TicketMessage[]
  
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  
  @@index([user_id])
  @@index([status])
  @@index([type])
}

model TicketMessage {
  id          String   @id @default(uuid())
  ticket_id   String
  ticket      SupportTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  
  sender_id   String   // User or Admin ID
  sender_type String   // CUSTOMER, ADMIN
  message     String   @db.Text
  
  created_at  DateTime @default(now())
  
  @@index([ticket_id])
}
